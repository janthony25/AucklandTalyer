@model List<AucklandTalyer.Models.Dto.CustomerIssueDto>



<div class="container mt-4">
    <h2 class="text-info">Customer Details</h2>

    <div class="border border-secondary p-3 col-3 mb-4">
        @foreach(var customer in Model)
        {
            <p><span class="text-info">Rego:</span><span class="fw-bold"> @customer.CarRego</span></p>
            <p><span class="text-info">Customer Name:</span><span class="fw-bold"> @customer.CustomerName</span></p>
            <p><span class="text-info">Car Make:</span><span class="fw-bold"> @customer.CarMake</span> </p>
            <p><span class="text-info">Car Model:</span><span class="fw-bold"> @customer.CarModel</span> </p>
            <p><span class="text-info">Payment Status:</span><span class="fw-bold"> @customer.PaymentStatus</span> </p>
        }
    </div>
    <div>
        <div class="row mb-2">
            <div class="col-6">
                <h3 class="text-info">Car Issue</h3>
            </div>
            <div class="col-6 text-end">
                
                   <a asp-controller="Issue" asp-action="Create" asp-route-Rego="@Model.FirstOrDefault().CarRego" class="btn btn-warning text-uppercase"><i class="bi bi-plus-circle"></i> Add Item</a>
                
            </div>
        </div>
            <table class="table table-bordered table-striped">
                <thead class="text-center align-middle">
                    <tr>
                        <th>Problem</th>
                        <th>Description</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody class="text-center align-center">
                @foreach(var issue in Model)
                {
                    <tr class="align-center">
                        <td>@issue.IssueName</td>
                        <td>@issue.IssueDescription</td>
                        <td>
                            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#problemDetailsModal">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                           @*  <button type="button" data-value="@issue.IssueId" id="addPartsModal" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                                Add Parts Need
                            </button> *@
                        </td>
                    </tr>
                }
            </tbody>

            </table>
    </div>
        
    </div>
</div>

 @* VIEW PROBLEM MODAL *@
<div class="modal fade" id="problemDetailsModal" tabindex="-1" aria-labelledby="exampleModalLabel2" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between">
                
                    <div>
                        <h5>
                        Car Issue: @foreach (var issue in Model)
                        {
                            <span class="fw-bold">@issue.IssueName</span>
                        }
                    </h5>
                    </div>
                    <div>
                        @foreach (var issue in Model)
                        {
                            <div>
                                <button type="button" data-value="@issue.IssueId" id="addPartsModal" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                                    Add Parts Need
                                </button>
                            </div>
                        }
                    </div>
            </div>
            <div class="modal-body">
                <table class="table table-bordered table-striped" id="issueWithPartsTable">
                    <thead>
                        <tr>
                            
                            <th>Part Name</th>
                            <th>Price ($)</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div> 


 @* ADD PARTS MODAL *@
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Add Parts</h5>
                <label id="modalValue" hidden></label> 
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered table-striped" id="partsTable">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Part Name</th>
                            <th>Price ($)</th>
                        </tr>
                    </thead>
                     <tbody>
                    </tbody> 
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#problemDetailsModal">
                    Back
                </button>
            @*     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> *@
                <button type="button" id="saveSelectedRowsBtn" class="btn btn-primary">Add</button>
            </div>
        </div>
    </div>
</div>


<script>
    $(document).ready(function () 
    {
        // AJAX request to the server to retrieve data
        $.ajax({
            url: "/Parts/GetPartsData",
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                // On successful response, call a function to populate the table
                populateTable(data);
            },
            error: function (xhr, status, error) {
                console.error(xhr.responseText);
            }
        });

        // RETRIVE DATA OF PARTS NEED IN MODAL
        $.ajax({
            url: "/Issue/GetIssuePartsData",
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                // On successful response, call a function to populate the table
                populateIssueWithPartsTable(data);
            },
            error: function (xhr, status, error) {
                console.error(xhr.responseText);
            }
        });
        
        // Pass data of checked check box
        $('#saveSelectedRowsBtn').click(function () {
            var checkedRows = [];
            var issueId = $('#modalValue').text();  
            $('input[name="selectedRows"]:checked').each(function () {
                var partsId = $(this).val();
             //   var name = $(this).closest('tr').find('td:eq(1)').text(); // Get the name from the second column
             //   var price = $(this).closest('tr').find('td:eq(2)').text(); // Get Price from the 3rd column
                checkedRows.push({ partsId: partsId, issueId: issueId });
             // checkedRows.push({ id: id, name: name, price: price });
            });
            console.log(checkedRows); // Output checked rows to console

            $.ajax({
                url: '@Url.Action("AddPartsInIssue", "Parts")',
                type: 'POST',
                data: { selectedRows: checkedRows },
                success: function (response) {
                    // Handle success response
                    console.log('Selected rows saved successfully.');
                },
                error: function (xhr, status, error) {
                    // Handle error
                    console.error('Error:', error);
                }
            });
        });
        
        $('#addPartsModal').click(function () {
            var value = $(this).data('value'); // Get the value from the data-value attribute
            $('#modalValue').text(value); // Set the value in the modal
            $('#exampleModal').modal('show'); // Show the modal
        });

    });

    function populateTable(data) {
        // Clear existing table rows
        $('#partsTable tbody').empty();

        // Iterate through the data and populate table rows
        $.each(data, function (index, item) {
            // Append a new row to the table body
         //   $('#partsTable tbody').append('<tr><td value="item.partsId">' + <label value="item.partsId" class="form-check-label" for= "flexCheckDefault" > + '</td><td value="item.partsName">' + item.partsName + '</td></tr>');
            $('#partsTable tbody').append('<tr><td><input name="selectedRows" class="form-check-input" type="checkbox" id="checkbox_' + item.partsId + '" value="' + item.partsId + '"></td><td>' + item.partsName + '</td><td>' + item.partsPrice + '</tr>');

        });
    }


    // PUPULATE DATA TABLE FOR ISSUE WITH PARTS TBALE
    function populateIssueWithPartsTable(data) {
        // Clear existing table rows
        $('#issueWithPartsTable tbody').empty();

        // Iterate through the data and populate table rows
        $.each(data, function (index, item) {
            // Append a new row to the table body
            //   $('#partsTable tbody').append('<tr><td value="item.partsId">' + <label value="item.partsId" class="form-check-label" for= "flexCheckDefault" > + '</td><td value="item.partsName">' + item.partsName + '</td></tr>');
            $('#issueWithPartsTable tbody').append('<tr><td>' + item.partsName + '</td><td>' + item.partsPrice + '</tr>');

        });
    }

   
</script>